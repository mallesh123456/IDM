package com.ril;

/*
 * * java program for request for account
 */


import java.io.BufferedReader;
import java.io.File;
import java.io.FileReader;
import java.util.HashMap;
import java.util.HashSet;
import java.util.Hashtable;
import java.util.List;
import java.util.Set;
import javax.naming.Context;
import oracle.iam.identity.usermgmt.api.UserManager;
import oracle.iam.identity.usermgmt.vo.User;
import oracle.iam.platform.OIMClient;
import oracle.iam.platform.entitymgr.vo.SearchCriteria;
import oracle.iam.provisioning.api.ApplicationInstanceService;
import oracle.iam.provisioning.api.ProvisioningService;
import oracle.iam.provisioning.vo.Account;
import oracle.iam.provisioning.vo.AccountData;
import oracle.iam.provisioning.vo.ApplicationInstance;

public class AccountRequest {

	public static void main(String[] args) throws Exception {

	    String ctxFactory = "weblogic.jndi.WLInitialContextFactory";
	    // OIMConnect oimConn = new OIMConnect();
	    OIMClient oimClient = null;
	    Hashtable<String, String> env = new Hashtable<String, String>();
	    env.put(Context.INITIAL_CONTEXT_FACTORY, ctxFactory);
	    env.put(Context.PROVIDER_URL, "t3://pdoim01.bss.jio.com:14000");

	    System.setProperty("OIM.AppServerType", "wls");
	    System.setProperty("APPSERVER_TYPE", "wls");
	    System.setProperty("java.security.auth.login.config", "C://Softwares//designconsole//config//authwl.conf");
	    oimClient = new OIMClient(env);     
	    oimClient.login("xelsysadm", "JioIAM0315".toCharArray());
        
        System.out.println("Connected");

        ApplicationInstanceService aiSvc = oimClient.getService(ApplicationInstanceService.class);
        ProvisioningService provSvc = oimClient.getService(ProvisioningService.class);
        UserManager usrMgr = oimClient.getService(UserManager.class);
        
        String appInstanceName = "PRMMaintainDealer";
        
	    File inputFile = new File("C:\\Oimapi\\AAA.txt");
	    FileReader fReader = new FileReader(inputFile);
	    
	    BufferedReader bReader = new BufferedReader(fReader);
	    String readData = bReader.readLine();
	    while (readData != null)
        {

        System.out.println("user: "+readData);    
        SearchCriteria criteria = new SearchCriteria("User Login", readData, SearchCriteria.Operator.BEGINS_WITH);
        Set retSet = new HashSet();
        retSet.add("usr_key");
        retSet.add("User Login");

        List<User> users = usrMgr.search(criteria, retSet, null);
        
        for (User u : users) {
        	ApplicationInstance ai = aiSvc.findApplicationInstanceByName(appInstanceName);

        	HashMap<String, Object> parentData = new HashMap<String, Object>();
        	AccountData accountData = new AccountData(ai.getAccountForm().getFormKey() + "", "", parentData);
        	Account account = new Account(ai, accountData);
                     account.setAccountType(Account.ACCOUNT_TYPE.Primary);
                
        	System.out.println("Provisioning app instance " + appInstanceName + " to user " + u.getEntityId());
        	provSvc.provision(u.getEntityId(), account);
                
                 }
                 readData = bReader.readLine();
             }
	    fReader.close();
	    bReader.close();
            
	    System.out.println("user operation completed");
            oimClient.logout();
            System.exit(0);
    		
	}
}
